<div class="breadcrumb">
  <h1>
    Usuarios
  </h1>
</div>

<div class="separator-breadcrumb border-top"></div>
<div class="row">
  <div class="col-md-12">
    <div class="card-header d-flex justify-content-end" *appHasPermission="'[CONFIGURATIONS][CREATE-USER]'">
      <button type="button" class="btn btn-primary ml-auto mb-2" (click)="open(modalCreate, null, 'CREATE')"
        placement="top" [ngbTooltip]="'Crear Usuario'">
        <fa-icon [icon]="faUserPlus"></fa-icon>
      </button>
    </div>

    <div class="card o-hidden">

      @if (loading) {
      <div class="text-center">
        <div class="spinner-bubble spinner-bubble-primary m-5"></div>
      </div>
      } @else {
      <ngx-datatable class="material fullscreen" [columnMode]="'force'" [headerHeight]="50" [footerHeight]="50"
        [rowHeight]="50" [rows]="rows" [columns]="columns" [offset]="pagination.currentPage - 1"
        [count]="pagination.totalElements" [externalPaging]="true" [limit]="pagination.itemsPerPage"
        (page)="loadPage($event.offset + 1)">

        <ngx-datatable-column [width]="100" name="Nombre" prop="name"></ngx-datatable-column>
        <ngx-datatable-column [width]="100" name="Ap Paterno" prop="lastName"></ngx-datatable-column>
        <ngx-datatable-column [width]="100" name="Ap Materno" prop="secondLastName"></ngx-datatable-column>
        <ngx-datatable-column [width]="200" name="Email" prop="email"></ngx-datatable-column>
        <ngx-datatable-column name="Rol">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ findRoleNameById(row.roleId) }}
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column name="Creación" prop="createdAt">
          <ng-template let-value="value" ngx-datatable-cell-template>
            {{ value | date: 'dd/MM/yyyy' }}
          </ng-template>
        </ngx-datatable-column>

        <!-- Columna Tools con botones -->
        <ngx-datatable-column name="Herramientas">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <div class="text-center m-top-neg-5">
              <div class="btn-group" role="group" aria-label="Tools">

                <button type="button" class="btn btn-danger" container="body" placement="top"
                  (click)="open(modalDelete, row, 'DELETE')" [ngbTooltip]="'Eliminar'" *appHasPermission="'[CONFIGURATIONS][DELETE-USER]'">
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>

                <button type="button" (click)="open(modalCreate, row, 'EDIT')" class="btn btn-info" container="body"
                  placement="top" [ngbTooltip]="'Editar'" *appHasPermission="'[CONFIGURATIONS][EDIT-USER]'">
                  <fa-icon [icon]="faEdit"></fa-icon>
                </button>

              </div>
            </div>

          </ng-template>
        </ngx-datatable-column>
      </ngx-datatable>
      }
    </div>

  </div>
</div>


<ng-template #modalDelete let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Crear Usuario</h4>
    <a href="javascript:void(0);" class="close" (click)="modal.dismiss('Cross click')">
      <fa-icon [icon]="faXmark"></fa-icon></a>
  </div>
  <div class="modal-body">
    <p>¿Esta seguro que desea <strong><span class="text-danger">eliminar</span></strong> al usuario <strong> {{
        user.name }} {{ user.lastName }} </strong>?</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary btn-rounded"
      (click)="modal.dismiss('cancel')">Cancelar</button>
    <btn-loading btnClass="btn btn-danger btn-rounded" [loadingText]="''" [loading]="loading"
      (click)="deleteUser()">Eliminar</btn-loading>
  </div>
</ng-template>

<ng-template #modalCreate let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">
      @if(actionSelected === 'EDIT') {
      Editar Usuario
      } @else {
      Nuevo Usuario
      }
    </h4>
    <a href="javascript:void(0);" class="close" (click)="modal.dismiss('Cross click')">
      <fa-icon [icon]="faXmark"></fa-icon></a>
  </div>
  <div class="modal-body">

    <form [formGroup]="userForm">
      <div class="form-group mb-3">
        <label for="firstName">Nombre</label>
        <input type="text" class="form-control" id="name" formControlName="name" placeholder="Nombre">
      </div>
      <div class="form-group mb-3">
        <label for="firstName">Apellido Paterno</label>
        <input type="text" class="form-control" id="lastName" formControlName="lastName" placeholder="Apellido Paterno">
      </div>
      <div class="form-group mb-3">
        <label for="firstName">Apellido Materno</label>
        <input type="text" class="form-control" id="secondLastName" formControlName="secondLastName"
          placeholder="Apellido Materno">
      </div>
      <div class="form-group mb-3">
        <label for="firstName">Email</label>
        <input type="email" class="form-control" id="email" formControlName="email" placeholder="Email">
      </div>
      <div class="form-group">
        <label for="firstName">Seleccione el rol</label>
        <select class="form-control" id="rol" formControlName="roleId">
          <option value="null" disabled>Seleccione el role</option>
          @for (item of roles; track $index) {
          <option [value]="+item.id">{{ item.name }}</option>
          }
        </select>
      </div>
    </form>
    <div class="form-group mb-3">
      <label for="companies">Empresas asociadas</label>
      <ngx-select-dropdown [instanceId]="'dropdown_2'" tabindex="0" [multiple]="true" [(ngModel)]="singleSelect"
        [config]="config" [options]="dataModel"></ngx-select-dropdown>
    </div>

  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary btn-rounded"
      (click)="modal.dismiss('cancel')">Cancelar</button>

    @if(actionSelected === 'EDIT') {
    <btn-loading btnClass="btn btn-info btn-rounded" [disabled]="userForm.invalid" [loadingText]="''"
      [loading]="loading" (click)="editUser()">
      Actualizar
    </btn-loading>
    } @else {
    <btn-loading btnClass="btn btn-primary btn-rounded" [disabled]="userForm.invalid" [loadingText]="''"
      [loading]="loading" (click)="createUser()">
      Crear
    </btn-loading>
    }

  </div>
</ng-template>